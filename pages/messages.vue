<template>
  <div>
    <div class="message-container">
            <div class="container">
                <div class="message-page">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="section-heading small blue">
                                <h4 class="ms-3"><svg width="18" height="18" viewBox="0 0 18 18" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M12.2744 9.63839C13.1562 8.94458 13.7999 7.99317 14.1158 6.91651C14.4317 5.83985 14.4043 4.69148 14.0371 3.63117C13.67 2.57087 12.9816 1.65135 12.0675 1.00054C11.1535 0.349732 10.0593 0 8.93728 0C7.81522 0 6.72106 0.349732 5.80702 1.00054C4.89298 1.65135 4.20451 2.57087 3.83741 3.63117C3.4703 4.69148 3.44281 5.83985 3.75875 6.91651C4.07469 7.99317 4.71836 8.94458 5.6002 9.63839C4.08914 10.2438 2.77069 11.2479 1.7854 12.5436C0.800116 13.8394 0.184929 15.3783 0.00542553 16.9961C-0.00756785 17.1143 0.00283191 17.2338 0.0360308 17.3479C0.0692296 17.462 0.124577 17.5684 0.198914 17.6612C0.349044 17.8484 0.567407 17.9683 0.805964 17.9946C1.04452 18.0208 1.28373 17.9512 1.47097 17.8011C1.65821 17.651 1.77815 17.4326 1.80439 17.194C2.0019 15.4357 2.84031 13.8118 4.15943 12.6326C5.47855 11.4533 7.18589 10.8014 8.95527 10.8014C10.7246 10.8014 12.432 11.4533 13.7511 12.6326C15.0702 13.8118 15.9086 15.4357 16.1061 17.194C16.1306 17.4151 16.2361 17.6192 16.4022 17.767C16.5683 17.9149 16.7833 17.9959 17.0056 17.9946H17.1046C17.3404 17.9674 17.5559 17.8482 17.7041 17.6629C17.8524 17.4776 17.9214 17.2411 17.8961 17.0051C17.7158 15.3827 17.0973 13.8399 16.1069 12.5421C15.1166 11.2443 13.7917 10.2406 12.2744 9.63839ZM8.93728 8.99976C8.22567 8.99976 7.53005 8.78874 6.93838 8.3934C6.3467 7.99805 5.88554 7.43613 5.61323 6.7787C5.34091 6.12126 5.26966 5.39784 5.40848 4.69991C5.54731 4.00198 5.88998 3.36089 6.39316 2.85771C6.89634 2.35453 7.53743 2.01187 8.23536 1.87304C8.93329 1.73421 9.65671 1.80546 10.3141 2.07778C10.9716 2.3501 11.5335 2.81126 11.9288 3.40293C12.3242 3.99461 12.5352 4.69023 12.5352 5.40183C12.5352 6.35606 12.1561 7.27121 11.4814 7.94595C10.8067 8.62069 9.89151 8.99976 8.93728 8.99976Z"
                                            fill="#1F1F1F" />
                                    </svg>
                                    Employees</h4>
                            </div>

                          <div class="section-search mt-3">
                          <div class="form-group">
                            <div class="search-icon">
                              <svg
                                width="18"
                                height="18"
                                viewBox="0 0 18 18"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path
                                  fill-rule="evenodd"
                                  clip-rule="evenodd"
                                  d="M15.4196 18C14.7599 18 14.1273 17.7382 13.6605 17.2721L11.6842 15.2958L11.683 15.2946C11.3191 14.9225 11.0809 14.4455 11.0021 13.931C10.9232 13.4159 11.0079 12.889 11.2444 12.4246L11.3466 12.2237L10.1665 11.0435L9.95123 11.2047C8.6915 12.1474 7.12139 12.578 5.55697 12.4097C3.99255 12.2413 2.54998 11.4866 1.51966 10.2974C0.489337 9.10822 -0.0522314 7.57286 0.00397507 6.00041C0.0601816 4.42796 0.709989 2.93519 1.82259 1.82259C2.93519 0.709989 4.42796 0.0601816 6.00041 0.00397506C7.57286 -0.0522314 9.10822 0.489337 10.2974 1.51966C11.4866 2.54998 12.2413 3.99255 12.4097 5.55697C12.578 7.12139 12.1474 8.6915 11.2047 9.95123L11.0435 10.1665L12.2259 11.3489L12.4219 11.2595C12.8872 11.0473 13.4054 10.9791 13.9098 11.0637C14.4123 11.1479 14.8783 11.38 15.2484 11.7302L17.1761 13.7045L17.3982 13.4877L17.1812 13.7096C17.4183 13.9414 17.6067 14.2183 17.7354 14.524C17.864 14.8297 17.9303 15.158 17.9303 15.4896C17.9303 15.8212 17.864 16.1495 17.7354 16.4552C17.6067 16.7609 17.4183 17.0377 17.1812 17.2696L17.1789 17.2719C16.7121 17.7381 16.0793 18 15.4196 18ZM14.324 12.6065L16.3008 14.5833C16.4171 14.6988 16.51 14.8367 16.573 14.988C16.6361 15.1395 16.6687 15.3021 16.6687 15.4663C16.6687 15.6304 16.6361 15.793 16.573 15.9445C16.51 16.0957 16.4178 16.2329 16.3017 16.3484C16.1863 16.4645 16.049 16.5567 15.8979 16.6197C15.7463 16.6828 15.5838 16.7153 15.4196 16.7153C15.2554 16.7153 15.0929 16.6828 14.9413 16.6197C14.79 16.5566 14.6527 16.4643 14.5372 16.348L12.5598 14.3707C12.4436 14.2552 12.3507 14.1173 12.2876 13.966C12.2245 13.8144 12.192 13.6519 12.192 13.4877C12.192 13.3235 12.2245 13.161 12.2876 13.0094C12.3506 12.8583 12.4428 12.721 12.5589 12.6056C12.6744 12.4895 12.8116 12.3973 12.9628 12.3343C13.1143 12.2712 13.2769 12.2386 13.441 12.2386C13.6052 12.2386 13.7678 12.2712 13.9193 12.3343C14.0707 12.3974 14.2085 12.4901 14.324 12.6065ZM7.15467 11.1088C8.11973 10.9178 9.00653 10.445 9.70305 9.75027C10.1665 9.28796 10.5342 8.73877 10.7851 8.13414C11.036 7.5295 11.1652 6.88131 11.1652 6.22669C11.1652 5.57207 11.036 4.92388 10.7851 4.31925C10.5342 3.71461 10.1665 3.16542 9.70305 2.70312C9.00653 2.00836 8.11973 1.53561 7.15467 1.3446C6.18961 1.15359 5.18958 1.25288 4.28092 1.62993C3.37227 2.00699 2.59574 2.64488 2.04944 3.46304C1.50314 4.2812 1.21157 5.24291 1.21157 6.22669C1.21157 7.21047 1.50314 8.17219 2.04944 8.99035C2.59574 9.8085 3.37227 10.4464 4.28092 10.8235C5.18958 11.2005 6.18961 11.2998 7.15467 11.1088Z"
                                  fill="#C0C0C0"
                                ></path>
                              </svg>
                            </div>
                            <input type="text" class="form-control" v-model="user_search"  placeholder="Search" />
                          </div>
                        </div>


                          <div v-if="!showEmptyEmployeesMessageComputed" class="employees-card-list full-height scroll-wrapper">
                              <div class="employees-name-card chat-user" v-for="(user) in usersListFilteredComputed" :key="user.enc_user_id" @click="loadChatForThisUser(user.enc_user_id)"
                              :class="[user.role_key, {active: (selectedEmployeeComputed) && user.enc_user_id == selectedEmployeeComputed.enc_user_id }]">
                                  <div class="tag">{{user.role_name}}</div>
                                  <div class="info">
                                      <h3>{{ user.full_name }}</h3>
                                      <h4>@{{ user.username }}</h4>
                                  </div>
                              </div>
                          </div>
                          <div v-else class="no-data">
                            <div>
                                <svg width="32" height="25"
                                    viewBox="0 0 32 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M15.822 12.6594L15.5858 12.8639L15.8704 12.9928C17.8117 13.8718 19.4587 15.2914 20.6146 17.0817C21.7704 18.8721 22.3862 20.9574 22.3882 23.0884C22.3882 23.4097 22.2605 23.7179 22.0333 23.9451C21.8061 24.1723 21.4978 24.3 21.1765 24.3C20.8551 24.3 20.5469 24.1723 20.3196 23.9451C20.0924 23.7178 19.9647 23.4096 19.9647 23.0882C19.9647 20.7887 19.0512 18.5833 17.4251 16.9572C15.7991 15.3312 13.5937 14.4176 11.2941 14.4176C8.99453 14.4176 6.78914 15.3312 5.16309 16.9572C3.53704 18.5833 2.62353 20.7887 2.62353 23.0882C2.62353 23.4096 2.49586 23.7178 2.26861 23.9451C2.04136 24.1723 1.73315 24.3 1.41176 24.3C1.09038 24.3 0.782167 24.1723 0.554918 23.9451C0.32769 23.7179 0.200025 23.4097 0.2 23.0883C0.202059 20.9573 0.817814 18.872 1.97364 17.0817C3.12949 15.2914 4.77652 13.8718 6.71779 12.9928L7.00245 12.8639L6.76619 12.6594C6.03459 12.0261 5.44779 11.2429 5.04561 10.3628C4.64343 9.48272 4.43528 8.52643 4.43529 7.55883C4.43529 5.73975 5.15792 3.99518 6.4442 2.7089C7.73048 1.42262 9.47504 0.7 11.2941 0.7C13.1132 0.7 14.8578 1.42262 16.144 2.7089C17.4303 3.99518 18.1529 5.73975 18.1529 7.55882C18.153 8.52643 17.9448 9.48272 17.5426 10.3628C17.1404 11.2429 16.5536 12.0261 15.822 12.6594ZM24.8952 12.1131L24.738 12.2901L24.9387 12.4155C26.747 13.5456 28.2362 15.1194 29.265 16.9872C30.2938 18.855 30.8278 20.9548 30.8165 23.0872V23.0882C30.8165 23.4096 30.6888 23.7178 30.4615 23.9451C30.2343 24.1723 29.9261 24.3 29.6047 24.3C29.2833 24.3 28.9751 24.1723 28.7479 23.9451C28.5207 23.718 28.3931 23.41 28.3929 23.0888C28.4079 21.1677 27.8737 19.2822 26.8532 17.6544C25.8334 16.0278 24.3704 14.7263 22.6362 13.9027L22.4655 13.8107L21.9227 13.4489L21.9217 13.4482C21.7498 13.3351 21.6095 13.1801 21.5141 12.9978C21.4188 12.8155 21.3714 12.612 21.3764 12.4064C21.3818 12.1991 21.4404 11.9966 21.5465 11.8184C21.6526 11.6402 21.8026 11.4922 21.9823 11.3885L21.9823 11.3885C22.6549 11.0002 23.2136 10.4422 23.6028 9.77024C23.992 9.09827 24.1979 8.33589 24.2 7.55936V7.55882C24.2 6.38251 23.7327 5.25438 22.9009 4.4226C22.0692 3.59082 20.941 3.12353 19.7647 3.12353C19.4433 3.12353 19.1351 2.99586 18.9079 2.76861L18.7664 2.91003L18.9079 2.76861C18.6806 2.54136 18.5529 2.23314 18.5529 1.91177C18.5529 1.59039 18.6806 1.28217 18.9079 1.05492L18.7664 0.913496L18.9079 1.05492C19.1351 0.827668 19.4433 0.7 19.7647 0.7L19.7648 0.7C21.0869 0.699647 22.3809 1.08142 23.4911 1.79936C24.6013 2.51731 25.4804 3.54082 26.0224 4.74671C26.5645 5.95259 26.7465 7.28944 26.5465 8.59634C26.3465 9.90324 25.773 11.1245 24.8952 12.1131ZM8.83 11.2466C9.55938 11.734 10.4169 11.9941 11.2941 11.9941C12.4704 11.9941 13.5986 11.5268 14.4303 10.6951C15.2621 9.86327 15.7294 8.73514 15.7294 7.55882C15.7294 6.68161 15.4693 5.82409 14.9819 5.09471C14.4946 4.36533 13.8019 3.79684 12.9914 3.46115C12.181 3.12545 11.2892 3.03762 10.4288 3.20875C9.56847 3.37989 8.77818 3.80231 8.15789 4.4226C7.5376 5.04288 7.11518 5.83318 6.94405 6.69354C6.77291 7.5539 6.86074 8.44569 7.19644 9.25614C7.53214 10.0666 8.10062 10.7593 8.83 11.2466Z"
                                        fill="#1B1B1B" fill-opacity="0.5" stroke="white"
                                        stroke-width="0.4" />
                                </svg>
                                <h4>No Users</h4>
                            </div>
                          </div>



                        </div>
                        <div class="col-md-9" v-if="selectedEmployeeComputed">
                            <div class="messages-wrapper">
                                <div class="title-header">
                                    <div class="section-heading small red">
                                        <h4 class="ms-3"><svg width="15" height="18" viewBox="0 0 15 18" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M4.5 7.2H5.4C5.63869 7.2 5.86761 7.10518 6.0364 6.9364C6.20518 6.76761 6.3 6.53869 6.3 6.3C6.3 6.06131 6.20518 5.83239 6.0364 5.6636C5.86761 5.49482 5.63869 5.4 5.4 5.4H4.5C4.2613 5.4 4.03239 5.49482 3.8636 5.6636C3.69482 5.83239 3.6 6.06131 3.6 6.3C3.6 6.53869 3.69482 6.76761 3.8636 6.9364C4.03239 7.10518 4.2613 7.2 4.5 7.2ZM4.5 9C4.2613 9 4.03239 9.09482 3.8636 9.2636C3.69482 9.43239 3.6 9.6613 3.6 9.9C3.6 10.1387 3.69482 10.3676 3.8636 10.5364C4.03239 10.7052 4.2613 10.8 4.5 10.8H9.9C10.1387 10.8 10.3676 10.7052 10.5364 10.5364C10.7052 10.3676 10.8 10.1387 10.8 9.9C10.8 9.6613 10.7052 9.43239 10.5364 9.2636C10.3676 9.09482 10.1387 9 9.9 9H4.5ZM14.4 6.246C14.3906 6.16332 14.3725 6.08187 14.346 6.003V5.922C14.3027 5.82946 14.245 5.7444 14.175 5.67L8.775 0.27C8.7006 0.199995 8.61554 0.142273 8.523 0.0989999C8.49613 0.0951841 8.46887 0.0951841 8.442 0.0989999C8.35057 0.0465671 8.2496 0.0129098 8.145 0H2.7C1.98392 0 1.29716 0.284464 0.790812 0.790812C0.284464 1.29716 0 1.98392 0 2.7V15.3C0 16.0161 0.284464 16.7028 0.790812 17.2092C1.29716 17.7155 1.98392 18 2.7 18H11.7C12.4161 18 13.1028 17.7155 13.6092 17.2092C14.1155 16.7028 14.4 16.0161 14.4 15.3V6.3V6.246ZM9 3.069L11.331 5.4H9.9C9.6613 5.4 9.43239 5.30518 9.2636 5.1364C9.09482 4.96761 9 4.73869 9 4.5V3.069ZM12.6 15.3C12.6 15.5387 12.5052 15.7676 12.3364 15.9364C12.1676 16.1052 11.9387 16.2 11.7 16.2H2.7C2.46131 16.2 2.23239 16.1052 2.0636 15.9364C1.89482 15.7676 1.8 15.5387 1.8 15.3V2.7C1.8 2.46131 1.89482 2.23239 2.0636 2.0636C2.23239 1.89482 2.46131 1.8 2.7 1.8H7.2V4.5C7.2 5.21608 7.48446 5.90284 7.99081 6.40919C8.49716 6.91554 9.18392 7.2 9.9 7.2H12.6V15.3ZM9.9 12.6H4.5C4.2613 12.6 4.03239 12.6948 3.8636 12.8636C3.69482 13.0324 3.6 13.2613 3.6 13.5C3.6 13.7387 3.69482 13.9676 3.8636 14.1364C4.03239 14.3052 4.2613 14.4 4.5 14.4H9.9C10.1387 14.4 10.3676 14.3052 10.5364 14.1364C10.7052 13.9676 10.8 13.7387 10.8 13.5C10.8 13.2613 10.7052 13.0324 10.5364 12.8636C10.3676 12.6948 10.1387 12.6 9.9 12.6Z"
                                                    fill="#1F1F1F" />
                                            </svg>
                                            Messages</h4>
                                        </div>

                                </div>

                                <div class="white-widget">
                                 <div class="message-box">
                                    <div class="user-info">
                                        <div class="d-flex"><h3>{{ selectedEmployee.full_name }}</h3> <span>{{selectedEmployee.role_name}}</span></div>
                                        <h4>@{{ selectedEmployee.username }}</h4>
                                    </div>

                                    <div class="conversation" id="chat-container" v-chat-scroll='{always: false}'>

                                        <ul class="overflow-auto">
                                            <li v-for="(message, index) in chatMessagesComputed" :key='index' :class="{received: message.sender_external_id != getUserEncryptedId}">
                                              <div class="message">{{message.text}}</div>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="send-message">
                                        <div class="send-input">
                                            <input type="text" class="form-control" placeholder="Aa" v-model="typedMessage" @keyup.enter="sendMessage()" />
                                        </div>
                                        <div class="send-btn">
                                            <button class="btn btn-primary" @click="sendMessage()">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.85056 0.0378758C3.53178 -0.0654388 4.22828 0.043822 4.84514 0.350762L21.6969 8.77664H21.7075C22.2392 9.05582 22.6864 9.47301 23.0018 9.98485C23.3275 10.5133 23.5 11.1218 23.5 11.7425C23.5 12.3632 23.3275 12.9717 23.0018 13.5001C22.6762 14.0284 22.2099 14.456 21.6556 14.735L4.85804 23.1337C4.38751 23.3641 3.87147 23.4864 3.34761 23.4918C2.78988 23.4915 2.24105 23.3518 1.75093 23.0856C1.26041 22.8192 0.844245 22.4344 0.540262 21.9662C0.236279 21.498 0.0541123 20.9613 0.0103177 20.4048C-0.0334687 19.8484 0.0625814 19.2896 0.289494 18.7798L3.16925 12.3365L3.17148 12.3311C3.24967 12.1447 3.28994 11.9446 3.28994 11.7425C3.28994 11.5403 3.24973 11.3402 3.17155 11.1538L0.289525 4.70525C0.0107465 4.07521 -0.0669829 3.37452 0.0669356 2.69869C0.200883 2.02271 0.540052 1.4045 1.0382 0.928325C1.53635 0.452156 2.16923 0.141207 2.85056 0.0378758ZM20.802 13.0329L20.688 12.8104L20.7998 13.034L3.9971 21.4353C3.73055 21.5633 3.43124 21.6067 3.1393 21.5598C2.84737 21.5128 2.57676 21.3778 2.36377 21.1727C2.15078 20.9676 2.00559 20.7022 1.94766 20.4123C1.88974 20.1223 1.92185 19.8216 2.03969 19.5504L2.04058 19.5484L4.90728 13.1074L4.90783 13.1061C4.94086 13.0294 4.96938 12.9509 4.99327 12.8709L5.04657 12.6924H13.5004C13.7523 12.6924 13.9939 12.5923 14.1721 12.4142C14.3502 12.236 14.4503 11.9944 14.4503 11.7425C14.4503 11.4905 14.3502 11.2489 14.1721 11.0708C13.9939 10.8926 13.7523 10.7925 13.5004 10.7925H5.04657L4.99327 10.6141C4.96938 10.5341 4.94086 10.4556 4.90783 10.3789L2.03969 3.93453C1.92185 3.66334 1.88974 3.3626 1.94766 3.07265C2.00559 2.78269 2.15078 2.51737 2.36377 2.31227C2.57676 2.10717 2.84737 1.97209 3.1393 1.92514C3.43124 1.8782 3.73055 1.92163 3.9971 2.04962L4.00069 2.05138L20.802 10.452C21.0395 10.5737 21.2388 10.7586 21.378 10.9862C21.5171 11.2139 21.5908 11.4756 21.5908 11.7425C21.5908 12.0093 21.5171 12.271 21.378 12.4987C21.2388 12.7264 21.0395 12.9112 20.802 13.0329Z" fill="white"/>
                                                    </svg>

                                            </button>
                                        </div>
                                    </div>

                                 </div>

                                </div>

                            </div>

                        </div>
                        <div v-else class="no-data col-md-9">
                            <div>
                                <svg width="32" height="25"
                                    viewBox="0 0 32 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M15.822 12.6594L15.5858 12.8639L15.8704 12.9928C17.8117 13.8718 19.4587 15.2914 20.6146 17.0817C21.7704 18.8721 22.3862 20.9574 22.3882 23.0884C22.3882 23.4097 22.2605 23.7179 22.0333 23.9451C21.8061 24.1723 21.4978 24.3 21.1765 24.3C20.8551 24.3 20.5469 24.1723 20.3196 23.9451C20.0924 23.7178 19.9647 23.4096 19.9647 23.0882C19.9647 20.7887 19.0512 18.5833 17.4251 16.9572C15.7991 15.3312 13.5937 14.4176 11.2941 14.4176C8.99453 14.4176 6.78914 15.3312 5.16309 16.9572C3.53704 18.5833 2.62353 20.7887 2.62353 23.0882C2.62353 23.4096 2.49586 23.7178 2.26861 23.9451C2.04136 24.1723 1.73315 24.3 1.41176 24.3C1.09038 24.3 0.782167 24.1723 0.554918 23.9451C0.32769 23.7179 0.200025 23.4097 0.2 23.0883C0.202059 20.9573 0.817814 18.872 1.97364 17.0817C3.12949 15.2914 4.77652 13.8718 6.71779 12.9928L7.00245 12.8639L6.76619 12.6594C6.03459 12.0261 5.44779 11.2429 5.04561 10.3628C4.64343 9.48272 4.43528 8.52643 4.43529 7.55883C4.43529 5.73975 5.15792 3.99518 6.4442 2.7089C7.73048 1.42262 9.47504 0.7 11.2941 0.7C13.1132 0.7 14.8578 1.42262 16.144 2.7089C17.4303 3.99518 18.1529 5.73975 18.1529 7.55882C18.153 8.52643 17.9448 9.48272 17.5426 10.3628C17.1404 11.2429 16.5536 12.0261 15.822 12.6594ZM24.8952 12.1131L24.738 12.2901L24.9387 12.4155C26.747 13.5456 28.2362 15.1194 29.265 16.9872C30.2938 18.855 30.8278 20.9548 30.8165 23.0872V23.0882C30.8165 23.4096 30.6888 23.7178 30.4615 23.9451C30.2343 24.1723 29.9261 24.3 29.6047 24.3C29.2833 24.3 28.9751 24.1723 28.7479 23.9451C28.5207 23.718 28.3931 23.41 28.3929 23.0888C28.4079 21.1677 27.8737 19.2822 26.8532 17.6544C25.8334 16.0278 24.3704 14.7263 22.6362 13.9027L22.4655 13.8107L21.9227 13.4489L21.9217 13.4482C21.7498 13.3351 21.6095 13.1801 21.5141 12.9978C21.4188 12.8155 21.3714 12.612 21.3764 12.4064C21.3818 12.1991 21.4404 11.9966 21.5465 11.8184C21.6526 11.6402 21.8026 11.4922 21.9823 11.3885L21.9823 11.3885C22.6549 11.0002 23.2136 10.4422 23.6028 9.77024C23.992 9.09827 24.1979 8.33589 24.2 7.55936V7.55882C24.2 6.38251 23.7327 5.25438 22.9009 4.4226C22.0692 3.59082 20.941 3.12353 19.7647 3.12353C19.4433 3.12353 19.1351 2.99586 18.9079 2.76861L18.7664 2.91003L18.9079 2.76861C18.6806 2.54136 18.5529 2.23314 18.5529 1.91177C18.5529 1.59039 18.6806 1.28217 18.9079 1.05492L18.7664 0.913496L18.9079 1.05492C19.1351 0.827668 19.4433 0.7 19.7647 0.7L19.7648 0.7C21.0869 0.699647 22.3809 1.08142 23.4911 1.79936C24.6013 2.51731 25.4804 3.54082 26.0224 4.74671C26.5645 5.95259 26.7465 7.28944 26.5465 8.59634C26.3465 9.90324 25.773 11.1245 24.8952 12.1131ZM8.83 11.2466C9.55938 11.734 10.4169 11.9941 11.2941 11.9941C12.4704 11.9941 13.5986 11.5268 14.4303 10.6951C15.2621 9.86327 15.7294 8.73514 15.7294 7.55882C15.7294 6.68161 15.4693 5.82409 14.9819 5.09471C14.4946 4.36533 13.8019 3.79684 12.9914 3.46115C12.181 3.12545 11.2892 3.03762 10.4288 3.20875C9.56847 3.37989 8.77818 3.80231 8.15789 4.4226C7.5376 5.04288 7.11518 5.83318 6.94405 6.69354C6.77291 7.5539 6.86074 8.44569 7.19644 9.25614C7.53214 10.0666 8.10062 10.7593 8.83 11.2466Z"
                                        fill="#1B1B1B" fill-opacity="0.5" stroke="white"
                                        stroke-width="0.4" />
                                </svg>
                                <h4>Select a user to chat</h4>
                            </div>
                          </div>
                    </div>

                </div>





            </div>
        </div>
  </div>
</template>

 <script>
 import { mapGetters } from 'vuex'

export default {
  name: 'Warrants',
  layout: 'master',

  data() {
    return {
      usersList: [],
      selectedEmployee: null,
      showEmptyChatMessage: false,
      selectedUserId: '',
      openedChatChannel: null,
      chatMessages: {},
      socketConnected: false,
      typedMessage: '',

      user_search: '',
      usersListFiltered: [],
    }
  },

  watch: {
    user_search(newValue, oldValue){
      if(newValue.length > 2){
          this.searchUsers(newValue)
      }else {

        this.usersListFiltered = Object.values(this.usersList)

        if(this.usersListFiltered.length > 0) {

          this.showEmptyEmployeesMessage = false
        }else {
          this.showEmptyEmployeesMessage = true
        }

      }
    }

  },

  mounted() {
    this.selectedUserId = this.$route.query.user_id
    this.fetchAllUsers()

    this.socket = this.$nuxtSocket({
      channel: ''
    })

    this.connectToSocket()

    /* Listen for events: */
      this.socket
      .on('on-connect', (flag, cb) => {
        this.socketConnected = flag
      })


    .on('on-message-receive', (msg, cb) => {
      var d = new Date();
      const time = d.getTime();

      if(msg.senderId === this.selectedEmployee.enc_user_id && msg.receiverId === this.getUserEncryptedId) {
        Object.assign(this.chatMessages ?? {}, {[time]: {text: msg.messageText, sender_external_id: msg.senderId}})
        this.typedMessage = this.typedMessage + ' '
        this.typedMessage = this.typedMessage.trim()
      }
      this.usersListFiltered.forEach((user, index) => {
        if(user.enc_user_id == msg.senderId) {
          this.usersListFiltered.splice(index, 1)
          this.usersListFiltered.splice(0, 0, user)
        }
      })
    })
  },

  computed: {
    usersListFilteredComputed () {
      return this.usersListFiltered
    },
    showEmptyEmployeesMessageComputed () {
      return this.usersListFiltered.length ? false : true
    },
    chatMessagesComputed () {
      return this.chatMessages
    },
    selectedEmployeeComputed () {
      return this.selectedEmployee
    },
    ...mapGetters({
      getUserEncryptedId: 'auth/getUserEncryptedId',
    })
  },

  methods: {
    searchUsers(searchedName) {
      this.showEmptyEmployeesMessage = false
      searchedName = searchedName.toLowerCase()
      var list = Object.values(this.usersList)
      const filtered = list.filter( (
            user,
            index,
            array
        ) => {
            let name = user.full_name.toLowerCase()
            if (name.includes(searchedName)) {
            return true
            } else {
            return false
            }
        })
        this.usersListFiltered = filtered
        if(this.usersListFiltered.length > 0) {
          this.showEmptyEmployeesMessage = false
        }else {
          this.showEmptyEmployeesMessage = true
        }
    },

    connectToSocket () {
      this.socket.emit('connection', {},
      (resp) => {})
    },

    loadChatForThisUser (userId) {
      this.selectedUserId = userId
      this.usersListFiltered.forEach((user, index) => {
          if(user.enc_user_id == this.selectedUserId) {
            this.selectedEmployee = user
            // fetch user channel
            this.fetchChatMessages(user.user_channel_id)
          }
        });
        this.connectToSocket()
    },

    async fetchAllUsers(){
      const selectedUserId = this.selectedUserId
      let users = this.usersListFiltered = this.usersList =
      await this.$store.dispatch(
        'chat/fetchAllChatUsers',
        {}
      )
      if(Object.keys(users).length > 0) {
        if(selectedUserId && (selectedUserId in users)) {
          const selectedEmployee = this.selectedEmployee = users[selectedUserId]
          const moveUser = {[selectedUserId]: users[selectedUserId]}
          delete users[selectedUserId]
          users = {...moveUser, ...users}
          this.usersListFiltered = Object.values(users)
          this.fetchChatMessages(selectedEmployee.user_channel_id)
        } else {
          this.usersListFiltered = Object.values(users)
        }

      } else {
        this.showEmptyMessage = true
      }

    },
    fetchChatChannel () {
      const senderId = this.getUserEncryptedId
      const receiverId = this.selectedUserId
      this.$store.dispatch(
        'chat/fetchChannel',
        {
          sender_id: senderId,
          receiver_id: receiverId
        }
      )
      .then((response) => {
        this.openedChatChannel = response
        if(this.openedChatChannel) {
          this.fetchChatMessages(this.openedChatChannel._id)
        }
      })
      .catch(() => {})
    },

    fetchChatMessages (channel_id) {
      this.$store.dispatch(
        'chat/fetchChatMessages', channel_id)
      .then((response) => {
        this.chatMessages = response
      })
      .catch(() => {})
    },

    sendMessage () {
      if(this.typedMessage) {
        var d = new Date();
        const time = d.getTime();
        Object.assign(this.chatMessages, {[time]: {text: this.typedMessage, sender_external_id: this.getUserEncryptedId}})

        this.socket.emit('send-message', {
          messageText: this.typedMessage,
          senderId: this.getUserEncryptedId,
          receiverId: this.selectedUserId,
          channelId: this.selectedEmployee.user_channel_id
        }, (resp) => {

        })
        this.saveMessage(
          {
            sender_external_id: this.getUserEncryptedId,
            text: this.typedMessage,
            channel_id: this.selectedEmployee.user_channel_id
          }
        )
        this.typedMessage = ''
      }
    },

    saveMessage (data) {
      this.$store.dispatch(
        'chat/sendMessage', data)
      .then((response) => {
        this.usersListFiltered.forEach((user, index) => {
          if(user.enc_user_id == this.selectedUserId) {
            this.usersListFiltered.splice(index, 1)
            this.usersListFiltered.splice(0, 0, this.selectedEmployee)
          }
        })
      })
      .catch(() => {})
    },
  }
}
</script>



<style scoped>
.chat-user:hover {
  cursor: pointer;
}
.messages-wrapper .white-widget{
    height: calc(100vh - 230px);
    position: relative;
}
.message-box .user-info {
    padding-bottom: 15px;
    border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}
.message-box .user-info .d-flex {
    align-items: center;
}
.message-box .user-info h3 {
    font-size: 18px;
    font-weight: normal;
    margin: 0;
}
.message-box .user-info h4 {
    font-size: 18px;
    font-weight: normal;
    margin: 0;
    color: rgba(27, 27, 27, 0.5);
}
.message-box .user-info .d-flex span {
    color: #5CA7FF;
    font-size: 14px;
    background: rgba(92, 167, 255, 0.05);
    border-radius: 10px;
    padding: 4px 9px;
    margin-left: 8px;
}
.conversation ul {
    margin: 0;
    padding: 0;
    list-style: none;
}
.conversation ul li {
    margin-bottom: 10px;
    text-align: right;
}
.conversation ul li.received {
    text-align: left;
}
.conversation ul li .message {
    color: #fff;
    font-size: 18px;
    background: #5CA7FF;
    border-radius: 15px;
    display: inline-block;
    padding: 3px 11px;
}
.conversation ul li.received .message {
    background: #F7F7F7;
    color: rgba(27, 27, 27, 0.75);
}

.send-message {
    display: flex;
    justify-content: space-between;
    padding-top: 7px;
    border-top: 0.5px solid rgba(0, 0, 0, 0.1);
    position: absolute;
    left: 20px;
    right: 20px;
    bottom: 15px;
}
.send-message .send-input {
    width: 100%;
}
.send-message textarea {
    height: 50px;
    resize: none;
    width: 100%;
}
.send-btn {
    margin-left: 10px;
}
.send-btn .btn {
    height: 50px;
    width: 50px;
    padding: 0;
}
.conversation {
    position: absolute;
    left: 20px;
    right: 20px;
    bottom: 75px;
    overflow: hidden;
    overflow-y: scroll;
    height: calc(100vh - 394px);
}
.employees-card-list.full-height {
    height: calc(100vh - 291px);
    overflow: hidden;
    overflow-y: scroll;
}
</style>
